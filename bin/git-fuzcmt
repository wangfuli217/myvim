#!/bin/bash

# Colorize terminal
red='\e[0;31m'
no_color='\033[0m'
# Console step increment
i=1

# Default settings
DRY_RUN="false"

# Script help text
TEXT_HELPER="\nThis script assists in constructing a conventional commit message with a gitmoji.
Available flags are:

  -d    (Optional) Dry run. Only displays the git commit command without executing it.
        Default is '$DRY_RUN'.

  -h    Display this help message.\n\n"

print_help() {
  printf "$TEXT_HELPER"
}

# Parse options
while getopts dh flag; do
  case "${flag}" in
    d) DRY_RUN="true";;
    h | *)
      print_help
      exit 0;;
  esac
done

check_packages() {
  for package in "$@"; do
    if ! command -v "$package" >/dev/null 2>&1; then
      echo -e "${red}Error: You need $package installed.${no_color}"
      exit 1
    fi
  done
}

check_packages gum fzf git

SCOPES="None
web
api
database
ci/cd
docs"

COMMIT_TYPES="fix: Fixes a bug in the code
feat: Adds or removes a new feature
docs: Updates documentation only
style: Changes code style/formatting without affecting meaning
refactor: Restructures code without changing API behavior
perf: Optimizes performance, often a specific kind of refactor
test: Adds or updates tests
build: Changes that affect the build system or dependencies
ops: Changes to infrastructure, deployment, or other operational components
chore: Other changes that donâ€™t modify src or test files, e.g., modifying .gitignore"

GITMOJIS="ðŸŽ¨ :art: Improve structure / format of the code.
âš¡ï¸ :zap: Improve performance.
ðŸ”¥ :fire: Remove code or files.
ðŸ› :bug: Fix a bug.
ðŸš‘ï¸ :ambulance: Critical hotfix.
âœ¨ :sparkles: Introduce new features.
ðŸ“ :memo: Add or update documentation.
ðŸš€ :rocket: Deploy stuff.
ðŸ’„ :lipstick: Add or update the UI and style files.
ðŸŽ‰ :tada: Begin a project.
âœ… :white_check_mark: Add, update, or pass tests.
ðŸ”’ï¸ :lock: Fix security or privacy issues.
ðŸ” :closed_lock_with_key: Add or update secrets.
ðŸ”– :bookmark: Release / Version tags.
ðŸš¨ :rotating_light: Fix compiler / linter warnings.
ðŸš§ :construction: Work in progress.
ðŸ’š :green_heart: Fix CI Build.
â¬‡ï¸ :arrow_down: Downgrade dependencies.
â¬†ï¸ :arrow_up: Upgrade dependencies.
ðŸ“Œ :pushpin: Pin dependencies to specific versions.
ðŸ‘· :construction_worker: Add or update CI build system.
ðŸ“ˆ :chart_with_upwards_trend: Add or update analytics or track code.
â™»ï¸ :recycle: Refactor code.
âž• :heavy_plus_sign: Add a dependency.
âž– :heavy_minus_sign: Remove a dependency.
ðŸ”§ :wrench: Add or update configuration files.
ðŸ”¨ :hammer: Add or update development scripts.
ðŸŒ :globe_with_meridians: Internationalization and localization.
âœï¸ :pencil2: Fix typos.
ðŸ’© :poop: Write bad code that needs to be improved.
âªï¸ :rewind: Revert changes.
ðŸ”€ :twisted_rightwards_arrows: Merge branches.
ðŸ“¦ï¸ :package: Add or update compiled files or packages.
ðŸ‘½ï¸ :alien: Update code due to external API changes.
ðŸšš :truck: Move or rename resources.
ðŸ“„ :page_facing_up: Add or update license.
ðŸ’¥ :boom: Introduce breaking changes.
ðŸ± :bento: Add or update assets.
â™¿ï¸ :wheelchair: Improve accessibility.
ðŸ’¡ :bulb: Add or update comments in source code.
ðŸ» :beers: Write code drunkenly.
ðŸ’¬ :speech_balloon: Add or update text and literals.
ðŸ—ƒï¸ :card_file_box: Perform database related changes.
ðŸ”Š :loud_sound: Add or update logs.
ðŸ”‡ :mute: Remove logs.
ðŸ‘¥ :busts_in_silhouette: Add or update contributor(s).
ðŸš¸ :children_crossing: Improve user experience / usability.
ðŸ—ï¸ :building_construction: Make architectural changes.
ðŸ“± :iphone: Work on responsive design.
ðŸ¤¡ :clown_face: Mock things.
ðŸ¥š :egg: Add or update an easter egg.
ðŸ™ˆ :see_no_evil: Add or update a .gitignore file.
ðŸ“¸ :camera_flash: Add or update snapshots.
âš—ï¸ :alembic: Perform experiments.
ðŸ”ï¸ :mag: Improve SEO.
ðŸ·ï¸ :label: Add or update types.
ðŸŒ± :seedling: Add or update seed files.
ðŸš© :triangular_flag_on_post: Add, update, or remove feature flags.
ðŸ¥… :goal_net: Catch errors.
ðŸ’« :dizzy: Add or update animations and transitions.
ðŸ—‘ï¸ :wastebasket: Deprecate code that needs to be cleaned up.
ðŸ›‚ :passport_control: Work on code related to authorization, roles, and permissions.
ðŸ©¹ :adhesive_bandage: Simple fix for a non-critical issue.
ðŸ§ :monocle_face: Data exploration/inspection.
âš°ï¸ :coffin: Remove dead code.
ðŸ§ª :test_tube: Add a failing test.
ðŸ‘” :necktie: Add or update business logic.
ðŸ©º :stethoscope: Add or update healthcheck.
ðŸ§± :bricks: Infrastructure related changes.
ðŸ§‘â€ðŸ’» :technologist: Improve developer experience.
ðŸ’¸ :money_with_wings: Add sponsorships or money related infrastructure.
ðŸ§µ :thread: Add or update code related to multithreading or concurrency.
ðŸ¦º :safety_vest: Add or update code related to validation."

printf "\nScript settings:\n"
printf "  -> dry run: ${red}${DRY_RUN}${no_color}\n"

printf "\n${red}${i}.${no_color} Select commit type\n\n"
i=$((i + 1))
TYPE=$(echo "$COMMIT_TYPES" | fzf --prompt="Select commit type: " | cut -d: -f1)

printf "\n${red}${i}.${no_color} Select scope (optional)\n\n"
i=$((i + 1))
SCOPE=$(echo "$SCOPES" | fzf --prompt="Select scope (optional, choose 'None' to skip): ")

printf "\n${red}${i}.${no_color} Select gitmoji\n\n"
i=$((i + 1))
GITMOJI=$(echo "$GITMOJIS" | fzf --prompt="Search for a gitmoji: " | awk '{print $1}')

if [ "$SCOPE" == "None" ]; then
  SCOPE=""
else
  SCOPE="($SCOPE)"
fi

SUMMARY=$(gum input --value "$TYPE$SCOPE: $GITMOJI " --placeholder "Summary of this change (optional)")
DESCRIPTION=$(gum write --placeholder "Detailed description of this change (optional)")

if [ -n "$DESCRIPTION" ]; then
    COMMIT_CMD="git commit -m \"$SUMMARY\" -m \"$DESCRIPTION\""
else
    COMMIT_CMD="git commit -m \"$SUMMARY\""
fi

if [ "$DRY_RUN" = "true" ]; then
    echo -e "\n${red}Dry Run:${no_color} $COMMIT_CMD"
else
    gum confirm "Confirm commit?" && eval "$COMMIT_CMD"
fi